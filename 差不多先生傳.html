<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ã€ˆé‚£é»˜é»˜çš„ä¸€ç¾¤ã€‰è³“æœæŒ‘æˆ°</title>
    <!-- è¼‰å…¥ Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f7f7;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
        }
        .bingo-cell {
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.06);
            border: 3px solid #cbd5e1;
            min-height: 100px;
            /* èª¿æ•´æ–‡å­—å¤§å°ä»¥å®¹ç´æ›´å¤šå…§å®¹ */
            font-size: 1.1rem;
            line-height: 1.4;
        }
        .answered-correct {
            background-color: #22c55e !important;
            color: white;
            border-color: #15803d !important;
            animation: pulse-green 1s ease-out;
        }
        .answered-incorrect {
            background-color: #f87171 !important;
            color: white;
            border-color: #dc2626 !important;
        }
        .bingo-line {
            background-color: #facc15 !important;
            color: #78350f !important;
            font-weight: bold;
            animation: wobble 0.5s infinite;
        }
        @keyframes pulse-green {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }
    </style>
</head>
<body class="p-4">
    
    <!-- 1. åˆ†çµ„æ’åé¸æ“‡ç•«é¢ -->
    <div id="rank-selection-screen" class="w-full max-w-2xl bg-white rounded-xl shadow-2xl p-6 md:p-8 text-center">
        <h2 class="text-3xl font-extrabold text-gray-800 mb-4 text-indigo-600">
            ğŸ² é¸æ“‡æœ¬çµ„ä»Šæ—¥æ’å
        </h2>
        <p class="text-gray-600 mb-8 text-lg">
            è«‹æ ¹æ“šåˆ†çµ„ç«¶è³½çš„ç¸½é«”æˆç¸¾ï¼Œé¸æ“‡æœ¬çµ„çš„æ’åå€é–“ï¼Œä»¥æ±ºå®šæœ¬æ¬¡æŒ‘æˆ°çš„**ç¸½ç­”éŒ¯æ©Ÿæœƒæ¬¡æ•¸**ã€‚
        </p>

        <div class="space-y-4">
            <button onclick="startGame(4)" class="w-full py-4 bg-green-500 hover:bg-green-600 text-white text-xl font-bold rounded-xl transition duration-150 shadow-lg transform hover:scale-[1.01]">
                ğŸ† æ’å 1-2 å - ç²å¾— 4 æ¬¡ç­”éŒ¯æ©Ÿæœƒ
            </button>
            <button onclick="startGame(3)" class="w-full py-4 bg-yellow-500 hover:bg-yellow-600 text-gray-900 text-xl font-bold rounded-xl transition duration-150 shadow-lg transform hover:scale-[1.01]">
                âœ¨ æ’å 3-5 å - ç²å¾— 3 æ¬¡ç­”éŒ¯æ©Ÿæœƒ
            </button>
        </div>

        <p class="text-sm text-gray-500 mt-6">
            é¸æ“‡å¾Œå°‡ç«‹å³é–‹å§‹éŠæˆ²ï¼Œè«‹ç¢ºèªï¼
        </p>
    </div>


    <!-- 2. ä¸»å®¹å™¨ï¼šBingo éŠæˆ² -->
    <div id="app" class="w-full max-w-2xl bg-white rounded-xl shadow-2xl p-6 md:p-8 hidden relative">
        
        <h1 class="text-3xl font-extrabold text-center text-gray-800 mb-6 border-b-4 border-yellow-500 pb-2">
            ã€ˆé‚£é»˜é»˜çš„ä¸€ç¾¤ã€‰è³“æœæŒ‘æˆ°
        </h1>
        <p class="text-center text-sm text-gray-600 mb-4">
            é»æ“Šæ ¼å­æŸ¥çœ‹é¡Œç›®ï¼Œä½œç­”å¾Œå³å¯æ¨™è¨˜çµæœä¸¦è¨ˆç®—é€£ç·šæ•¸ã€‚ï¼ˆ**æ‰€æœ‰é¡Œç›®å…±äº«ç­”éŒ¯æ©Ÿæœƒ**ï¼‰
        </p>

        <!-- è³“æœç¶²æ ¼ (3x3) -->
        <div id="bingo-grid" class="grid grid-cols-3 gap-3 md:gap-4">
            <!-- æ ¼å­å°‡ç”± JavaScript å‹•æ…‹ç”Ÿæˆ -->
        </div>

        <!-- éŠæˆ²ç‹€æ…‹èˆ‡è¨ˆåˆ†å€ -->
        <div class="mt-8 p-4 bg-yellow-50 border-l-4 border-yellow-500 rounded-lg shadow-inner">
            <div class="text-xl font-bold text-gray-800 mb-2">æŒ‘æˆ°ç‹€æ…‹ï¼š</div>
            <p id="correct-count" class="text-lg text-gray-700">âœ… ç­”å°é¡Œæ•¸ï¼š<span class="font-bold text-green-600">0</span> / 9</p>
            <p id="bingo-count" class="text-lg text-gray-700">ğŸ† å®Œæˆé€£ç·šï¼š<span class="font-bold text-yellow-700">0</span> æ¢</p>
            
            <!-- ç¸½åˆ†æ¬„ä½ -->
            <p id="total-score" class="text-xl text-gray-800 font-extrabold mt-3 border-t pt-2">
                ç¸½åˆ†ï¼š<span class="text-indigo-600">0</span> åˆ†
            </p>
            
            <!-- å‰©é¤˜æ©Ÿæœƒé¡¯ç¤º -->
            <p class="text-lg text-gray-700">âŒ å‰©é¤˜ç­”éŒ¯æ©Ÿæœƒï¼š<span id="attempts-left-display" class="font-bold text-red-600">0 / 0</span></p>
            
            <p id="status-message" class="mt-3 text-red-600 font-semibold hidden">æ­å–œï¼ä½ å€‘å®Œæˆé€£ç·šäº†ï¼</p>
        </div>
    </div>

    <!-- æ¨¡æ…‹æ¡† (Modal) - ç”¨æ–¼é¡¯ç¤ºé¡Œç›®å’Œé¸é … -->
    <div id="question-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 z-50 flex justify-center items-center p-4 hidden">
        <div class="bg-white rounded-xl p-6 md:p-8 w-full max-w-lg shadow-2xl transform transition-all duration-300">
            
            <!-- æ¨™é¡Œèˆ‡é—œé–‰æŒ‰éˆ•å®¹å™¨ (Flex ä½ˆå±€) -->
            <div class="flex justify-between items-center mb-4 border-b pb-2">
                <h3 class="text-xl font-bold text-gray-800 mr-4" id="modal-title"></h3>
                <!-- é—œé–‰æŒ‰éˆ• -->
                <button onclick="closeModal()" class="w-24 py-2 bg-indigo-600 hover:bg-indigo-700 text-white text-sm font-bold rounded-lg transition duration-150 shadow-md flex-shrink-0">
                    é—œé–‰
                </button>
            </div>
            
            <p class="text-gray-700 mb-6 text-lg" id="modal-question-text"></p>

            <!-- é¸é …å€ -->
            <div id="modal-options" class="space-y-3">
                <!-- é¸é …å°‡ç”± JavaScript å‹•æ…‹ç”Ÿæˆ -->
            </div>

            <!-- çµæœè¨Šæ¯ -->
            <div id="result-message" class="mt-6 p-3 rounded-lg text-center font-bold hidden"></div>

            <!-- åº•éƒ¨ç”¨æ–¼é–“éš” -->
            <div class="mt-4"></div>
        </div>
    </div>

    <script>
        // ----------------------------------------------------
        // 1. é¡Œç›®æ•¸æ“š (æœ€çµ‚å®šæ¡ˆç‰ˆæœ¬)
        // ----------------------------------------------------
        const OPTIONS_LABELS = ['A', 'B', 'C', 'D'];
        const QUESTIONS = [
            {
                id: 1,
                core: 'ä¿®è¾­ (è­¬å–»)',
                question: 'ã€Œåƒå£«å…µå€‘è­·è¡›ç–†åœŸé‚£æ¨£ã€ä¸€å¥ï¼Œé‹ç”¨äº†ä½•ç¨®ä¿®è¾­æŠ€å·§ï¼Ÿ',
                options: ['è­¬å–»', 'è½‰åŒ–', 'èª‡é£¾', 'è¨­å•'],
                answerIndex: 0, // A
            },
            {
                id: 2,
                core: 'æ¯”å–»',
                question: 'èª²æ–‡ä¸­å°‡é€™ã€Œé»˜é»˜çš„ä¸€ç¾¤ã€æ¯”å–»æˆä»€éº¼ï¼Ÿ',
                options: ['å¿ å¯¦çš„ç‰§ç¾Šäºº', 'å …æ¯…çš„é§±é§éšŠ', 'æˆ´ç›”ç”²çš„é¨å£«', 'è­·è¡›è‘—ç–†åœŸçš„å£«å…µ'],
                answerIndex: 3, // D
            },
            {
                id: 3,
                core: 'è©èªç†è§£ (é»˜é»˜)',
                question: 'ã€Œè² è²¬é“è·¯æ¸…æ½”çš„é‚£é»˜é»˜çš„ä¸€ç¾¤ï¼Œä»¥å¿ å¯¦çš„æ…‹åº¦ï¼Œè­·è¡›è‘—ä¸€æ¢æ¢é•·é•·çš„è¡—é“å’Œå··å¼„ã€‚ã€å¥ä¸­ã€Œé»˜é»˜ã€äºŒå­—é»å‡ºæ¸…é“å©¦çš„ä½•ç¨®ç²¾ç¥ï¼Ÿ',
                options: [
                    'ä¸å¼µæšä¸è¡¨åŠŸï¼ŒèªçœŸåŠªåŠ›çš„å¥‰ç»ç²¾ç¥',
                    'æ¸…æ™¨æ°£æ°›å¯§éœï¼Œé¿å…æ“¾äººçš„é«”è²¼ç²¾ç¥',
                    'å‡Œæ™¨æ‘¸é»‘èµ·åºŠï¼Œç¡æ„çŒ¶ççš„åˆ»è‹¦ç²¾ç¥',
                    'å°ˆæ³¨å®Œæˆå·¥ä½œï¼Œç„¡æš‡èªªè©±çš„ç©æ¥µç²¾ç¥'
                ],
                answerIndex: 0, // A
            },
            {
                id: 4,
                core: 'æˆèªæ‡‰ç”¨ (ä»”ç´°)',
                question: 'ã€Œåˆ¥çœ‹å¥¹å€‘æ‰€è² è²¬çš„è·¯æ®µæ˜¯é‚£æ¨£å¯¬é•·ï¼Œå¥¹å€‘å»å¿ å¯¦çš„ä¸€æƒæŠŠä¸€æƒæŠŠçš„æƒéä¾†ã€‚ã€ä¸‹åˆ—ä½•è€…æœ€é©åˆç”¨ä¾†å½¢å®¹æ¸…é“å©¦æ‰“æƒçš„æƒ…å½¢ï¼Ÿ',
                options: ['è€ç•¶ç›Šå£¯', 'é‰…ç´°é¡éº', 'å‰å€¨å¾Œæ­', 'é­é•·è«åŠ'],
                answerIndex: 1, // B
            },
            {
                id: 5,
                core: 'æ–‡æ„ (æ™‚é–“)',
                question: 'ã€ŒæŠ«è‘—ä¸€èº«æ·¡æ·¡çš„å¤œè‰²ï¼Œä¾¿é–‹å§‹å·¥ä½œã€é€™å¥è©±ä¸»è¦æå¯«äº†æ¸…é“å©¦å·¥ä½œçš„å“ªå€‹é¢å‘ï¼Ÿ',
                options: ['ä»–å€‘å·¥ä½œçš„æ™‚é–“å¾ˆçŸ­æš«', 'ä»–å€‘å·¥ä½œæ™‚æœƒé®è“‹é¢å®¹', 'ä»–å€‘é–‹å§‹å·¥ä½œæ™‚å¤©è‰²æœªäº®', 'ä»–å€‘å·¥ä½œç¸½æ˜¯åœ¨æ·±å¤œé€²è¡Œ'],
                answerIndex: 2, // C
            },
            {
                id: 6,
                core: 'èª²æ–‡ç´°ç¯€',
                question: 'èª²æ–‡ä¸­æåˆ°ï¼Œç•¶ã€Œæˆ‘ã€çœ‹åˆ°ä»–å€‘çš„æ™‚å€™ï¼Œä»–å€‘çš„æ¸…æƒå·¥ä½œè™•æ–¼å“ªç¨®ç‹€æ…‹ï¼Ÿ',
                options: ['æ­£æº–å‚™é–‹å§‹æ‰“æƒ', 'æ­£è¦æ”¶å·¥ä¼‘æ¯', 'å·²ç¶“é–‹å§‹å¾ˆä¹…äº†', 'æ­£åœ¨æ•´ç†æ‰“æƒå·¥å…·'],
                answerIndex: 2, // C
            },
            {
                id: 7,
                core: 'å·¥ä½œå¿ƒæ…‹ (è·è²¬)',
                question: 'ã€Œå‡¡è¢«èªç‚ºæ˜¯åƒåœ¾çš„é‚£äº›æ±è¥¿å‡ºç¾åœ¨ä»–å€‘çš„é˜²å€ï¼Œä»–å€‘ä¾¿äºˆä»¥æ¸…é™¤ã€‚ã€é€™å¥è©±è¡¨ç¾å‡ºæ¸…é“å©¦çš„ä½•ç¨®å·¥ä½œå¿ƒæ…‹ï¼Ÿ',
                options: ['å¤©ä¸Šå¤©ä¸‹ï¼Œå”¯æˆ‘ç¨å°Š', 'ä¸€å¤«ç•¶é—œï¼Œè¬å¤«è«æ•µ', 'å…µä¾†å°‡æ“‹ï¼Œæ°´ä¾†åœŸæ©', 'è·è²¬æ‰€åœ¨ï¼Œç¾©ä¸å®¹è¾­'],
                answerIndex: 3, // D
            },
            {
                id: 8,
                core: 'æ–‡æ„ç†è§£ (ç¯„åœ)',
                question: 'ã€Œæˆ‘ä¸çŸ¥é“å¥¹å€‘æ˜¯è‡ªä»€éº¼åœ°æ–¹æƒèµ·ï¼Œä¹Ÿä¸çŸ¥é“å¥¹å€‘æƒåˆ°ä»€éº¼åœ°æ–¹ç‚ºæ­¢ã€‚ã€é€™å¥è©±ä¸»è¦èªªæ˜äº†ä»€éº¼ï¼Ÿ',
                options: ['æ¸…é“å©¦çš„å·¥ä½œç¯„åœæ¥µå»£ï¼Œè²¬ä»»ä¸è¼•', 'ä½œè€…å°æ¸…é“å©¦å·¥ä½œå…§å®¹ä¸é—œå¿ƒ', 'æ¸…é“å©¦å·¥ä½œæ–¹å¼éå¸¸éš±å¯†', 'æ¸…æ½”å·¥ä½œç¶“å¸¸è®Šæ›åœ°é»'],
                answerIndex: 0, // A
            },
            {
                id: 9,
                core: 'æ³¨éŸ³/å­—å½¢å¡«ç©º',
                question: 'ã€Œé‚£å€‹ã€ã€€ã€ç”Ÿäººæ²‰ã€ã€€ã€ä¸èªçš„ååœ¨è§’è½ï¼Œé¡¯å¾—æœ‰äº›è½ã€ã€€ã€ï¼Œã€ã€€ã€éä»–è¦ºå¾—æˆ‘å€‘å°ä»–å¤ªéå†·ã€ã€€ã€ï¼Ÿã€ä¸Šè¿°æ–‡å¥ã€ã€€ã€ä¸­çš„å­—ï¼Œä¾åºæ‡‰ç‚ºä¸‹åˆ—ä½•è€…ï¼Ÿ',
                options: ['é™Œï¼é»˜ï¼æ¼ ï¼è«ï¼å¯', 'æ¼ ï¼é»˜ï¼å¯ï¼è«ï¼é™Œ', 'æ¼ ï¼é»˜ï¼æ¼ ï¼æ¼ ï¼è«', 'é™Œï¼é»˜ï¼å¯ï¼è«ï¼æ¼ '],
                answerIndex: 3, // D
            },
        ];

        // è³“æœç‹€æ…‹è¿½è¹¤ï¼š
        // çµæ§‹ï¼š{state: number (0/1/2), choice: string ('A'/'B'/'C'/'D'æˆ–å…¶ä»–)}
        let quizState = Array(9).fill().map(() => ({ state: 0, choice: '' }));
        
        // å…¨å±€ç‹€æ…‹è¿½è¹¤
        let totalFailedAttempts = 0;
        let TOTAL_MAX_ATTEMPTS = 0; 
        let currentQuestionIndex = -1; 
        let autoCloseTimer; 
        let failedOptions = []; 
        
        const BINGO_LINES = [
            [0, 1, 2], [3, 4, 5], [6, 7, 8], 
            [0, 3, 6], [1, 4, 7], [2, 5, 8], 
            [0, 4, 8], [2, 4, 6]            
        ];

        // ----------------------------------------------------
        // 2. DOM å…ƒç´ ç²å–
        // ----------------------------------------------------
        const rankScreen = document.getElementById('rank-selection-screen'); 
        const bingoApp = document.getElementById('app'); 
        const bingoGrid = document.getElementById('bingo-grid');
        const modal = document.getElementById('question-modal');
        const modalTitle = document.getElementById('modal-title');
        const modalQuestionText = document.getElementById('modal-question-text');
        const modalOptions = document.getElementById('modal-options');
        const resultMessage = document.getElementById('result-message');
        const correctCountEl = document.querySelector('#correct-count span');
        const bingoCountEl = document.querySelector('#bingo-count span');
        const totalScoreEl = document.querySelector('#total-score span');
        const statusMessageEl = document.getElementById('status-message');
        const attemptsDisplayEl = document.getElementById('attempts-left-display');

        // ----------------------------------------------------
        // 3. æ ¸å¿ƒéŠæˆ²é‚è¼¯
        // ----------------------------------------------------
        
        /**
         * æ›´æ–°å‰©é¤˜ç­”éŒ¯æ©Ÿæœƒçš„é¡¯ç¤º
         */
        function updateAttemptsDisplay() {
            const attemptsLeft = TOTAL_MAX_ATTEMPTS - totalFailedAttempts;
            attemptsDisplayEl.textContent = `${Math.max(0, attemptsLeft)} / ${TOTAL_MAX_ATTEMPTS}`;
            if (attemptsLeft <= 0) {
                attemptsDisplayEl.classList.add('text-red-600');
            } else {
                attemptsDisplayEl.classList.remove('text-red-600');
            }
        }

        /**
         * é‡æ–°æ¸²æŸ“é¸é …å€åŸŸ
         */
        function reRenderOptions(index, disableAll = false, failedOptions = []) {
            const question = QUESTIONS[index];
            modalOptions.innerHTML = '';

            question.options.forEach((option, idx) => {
                const label = ['(A)', '(B)', '(C)', '(D)'][idx];
                const button = document.createElement('button');
                
                let buttonClasses = 'w-full text-left py-3 px-4 rounded-lg border-2 border-gray-300 text-gray-700 font-medium transition duration-150';
                
                button.className = buttonClasses;
                button.textContent = `${label} ${option}`;

                if (failedOptions.includes(idx)) {
                    button.disabled = true;
                    button.classList.remove('hover:bg-gray-100');
                    button.classList.add('bg-gray-200', 'text-gray-500', 'cursor-not-allowed');
                } else if (disableAll) {
                    button.disabled = true;
                    button.classList.add('cursor-not-allowed');
                } else {
                    button.classList.add('hover:bg-gray-100');
                    button.onclick = () => checkAnswer(idx);
                }
                
                modalOptions.appendChild(button);
            });
        }


        /**
         * æª¢æŸ¥è³“æœé€£ç·šæ•¸ä¸¦æ›´æ–°UI 
         * @returns {number} è¿”å›ç›®å‰çš„é€£ç·šæ•¸
         */
        function checkBingo() {
            let bingoCount = 0;
            const cells = bingoGrid.children;

            Array.from(cells).forEach(cell => cell.classList.remove('bingo-line'));

            BINGO_LINES.forEach((line) => {
                const [i, j, k] = line;
                
                // æª¢æŸ¥ç‹€æ…‹çš„ state å±¬æ€§
                const isBingo = quizState[i].state === 2 && quizState[j].state === 2 && quizState[k].state === 2;
                
                if (isBingo) {
                    bingoCount++;
                    cells[i].classList.add('bingo-line');
                    cells[j].classList.add('bingo-line');
                    cells[k].classList.add('bingo-line');
                }
            });

            bingoCountEl.textContent = bingoCount;
            if (bingoCount > 0) {
                statusMessageEl.classList.remove('hidden');
            } else {
                statusMessageEl.classList.add('hidden');
            }
            return bingoCount;
        }

        /**
         * æª¢æŸ¥ç­”æ¡ˆä¸¦æ›´æ–°ç‹€æ…‹
         */
        function checkAnswer(selectedIndex) {
            const question = QUESTIONS[currentQuestionIndex];
            const isCorrect = selectedIndex === question.answerIndex;
            const selectedChoiceLabel = OPTIONS_LABELS[selectedIndex];
            
            clearTimeout(autoCloseTimer);
            resultMessage.classList.remove('hidden');
            
            if (isCorrect) {
                if (quizState[currentQuestionIndex].state !== 2) {
                    quizState[currentQuestionIndex].state = 2;
                    quizState[currentQuestionIndex].choice = selectedChoiceLabel; // å„²å­˜é¸é …
                }

                resultMessage.className = 'mt-6 p-3 rounded-lg text-center font-bold bg-green-100 text-green-700';
                resultMessage.textContent = 'âœ… ç­”å°äº†ï¼æ­å–œç²å¾—æ­¤æ ¼ã€‚';
                
                reRenderOptions(currentQuestionIndex, true); 
                modalOptions.children[selectedIndex].classList.add('bg-green-500', 'text-white');

                updateGridCell(currentQuestionIndex);
                updateScore();
                updateAttemptsDisplay();
                autoCloseTimer = setTimeout(closeModal, 15000); 

            } else {
                if (quizState[currentQuestionIndex].state === 0) {
                    totalFailedAttempts++; 
                }
                
                failedOptions.push(selectedIndex); 

                const newAttemptsLeft = TOTAL_MAX_ATTEMPTS - totalFailedAttempts;
                
                resultMessage.className = 'mt-6 p-3 rounded-lg text-center font-bold bg-red-100 text-red-700';
                updateAttemptsDisplay(); 
                    
                if (newAttemptsLeft < 0) { 
                    if (quizState[currentQuestionIndex].state === 0) {
                        quizState[currentQuestionIndex].state = 1; 
                        quizState[currentQuestionIndex].choice = selectedChoiceLabel; // å„²å­˜æœ€å¾Œä¸€æ¬¡é¸é …
                    }
                    
                    resultMessage.textContent = `âŒ ç­”éŒ¯äº†ï¼æ‰€æœ‰æ©Ÿæœƒå·²ç”¨ç›¡ã€‚æ­£ç¢ºç­”æ¡ˆæ˜¯ ${['(A)', '(B)', '(C)', '(D)'][question.answerIndex]}ã€‚`;
                    
                    reRenderOptions(currentQuestionIndex, true); 
                    modalOptions.children[question.answerIndex].classList.add('border-4', 'border-green-500', 'bg-green-50');
                    
                    updateGridCell(currentQuestionIndex);
                    updateScore();
                    autoCloseTimer = setTimeout(closeModal, 15000);

                } else {
                    if (newAttemptsLeft === 0) {
                         resultMessage.textContent = `âŒ ç­”éŒ¯äº†ï¼ä½ å·²ç”¨ç›¡æ‰€æœ‰ ${TOTAL_MAX_ATTEMPTS} æ¬¡æ©Ÿæœƒã€‚æ­¤é¡Œç„¡æ³•å†ä½œç­”ã€‚`;
                         
                         quizState[currentQuestionIndex].state = 1;
                         quizState[currentQuestionIndex].choice = selectedChoiceLabel; // å„²å­˜é¸é …
                         reRenderOptions(currentQuestionIndex, true); 
                         modalOptions.children[question.answerIndex].classList.add('border-4', 'border-green-500', 'bg-green-50');

                         updateGridCell(currentQuestionIndex);
                         updateScore();
                         autoCloseTimer = setTimeout(closeModal, 15000); 

                    } else {
                        resultMessage.textContent = `âŒ ç­”éŒ¯äº†ï¼ä½ é‚„æœ‰ ${newAttemptsLeft} æ¬¡æ©Ÿæœƒã€‚è«‹é‡æ–°é¸æ“‡ã€‚`;
                        
                        setTimeout(() => {
                            reRenderOptions(currentQuestionIndex, false, failedOptions); 
                            modalTitle.textContent = `ç¬¬ ${currentQuestionIndex + 1} é¡Œ (å‰©é¤˜æ©Ÿæœƒ: ${newAttemptsLeft})`;
                            resultMessage.classList.add('hidden'); 
                        }, 1000); 
                    }
                } 
            }
        }

        /**
         * æ›´æ–°å–®å€‹è³“æœæ ¼å­çš„æ¨£å¼
         */
        function updateGridCell(index) {
            const cell = bingoGrid.children[index];
            const stateObj = quizState[index];

            cell.classList.remove('answered-correct', 'answered-incorrect', 'text-white'); 
            
            if (stateObj.state === 2) {
                cell.classList.add('answered-correct', 'text-white');
                // é¡¯ç¤ºï¼šâœ… ç­”å° (A)
                cell.innerHTML = `âœ… ç­”å°<br/>(${stateObj.choice})`;
            } else if (stateObj.state === 1) {
                cell.classList.add('answered-incorrect', 'text-white');
                 // é¡¯ç¤ºï¼šâŒ ç­”éŒ¯ (B)
                cell.innerHTML = `âŒ ç­”éŒ¯<br/>(${stateObj.choice})`;
            } else {
                cell.textContent = `Q${index + 1}`;
            }
        }

        /**
         * æ›´æ–°ç­”å°é¡Œæ•¸å’Œç¸½åˆ†é¡¯ç¤º
         */
        function updateScore() {
            // è¨ˆç®—ç­”å°é¡Œæ•¸ï¼šåªè¨ˆç®— state === 2 çš„
            const correctCount = quizState.filter(item => item.state === 2).length;
            
            const bingoCount = checkBingo();
            
            const attemptsLeft = Math.max(0, TOTAL_MAX_ATTEMPTS - totalFailedAttempts);

            const totalScore = correctCount + bingoCount + attemptsLeft;

            correctCountEl.textContent = totalScore;
            totalScoreEl.textContent = totalScore;
        }

        // ----------------------------------------------------
        // 4. æ¨¡æ…‹æ¡† (Modal) è™•ç†
        // ----------------------------------------------------

        /**
         * é¡¯ç¤ºé¡Œç›®æ¨¡æ…‹æ¡†
         */
        function openModal(index) {
            currentQuestionIndex = index;
            const question = QUESTIONS[index];
            
            clearTimeout(autoCloseTimer); 
            
            const stateObj = quizState[index];
            const attemptsLeft = TOTAL_MAX_ATTEMPTS - totalFailedAttempts;
            
            if (stateObj.state !== 0) {
                modalTitle.textContent = `ç¬¬ ${index + 1} é¡Œ (å·²ä½œç­”ï¼š${stateObj.choice})`;
            } else {
                modalTitle.textContent = `ç¬¬ ${index + 1} é¡Œ (å‰©é¤˜æ©Ÿæœƒ: ${attemptsLeft})`;
            }
            
            modalQuestionText.textContent = question.question;
            modalOptions.innerHTML = '';
            resultMessage.classList.add('hidden');
            failedOptions = []; 

            if (stateObj.state !== 0) {
                reRenderOptions(index, true); 
                
                const correctBtn = modalOptions.children[question.answerIndex];
                
                if (stateObj.state === 2) {
                    resultMessage.className = 'mt-6 p-3 rounded-lg text-center font-bold bg-green-100 text-green-700';
                    resultMessage.textContent = `âœ… æ­¤é¡Œå·²ç­”å°ï¼ä½ é¸æ“‡äº† (${stateObj.choice})`;
                    correctBtn.classList.add('bg-green-500', 'text-white');
                } else if (stateObj.state === 1) {
                    resultMessage.className = 'mt-6 p-3 rounded-lg text-center font-bold bg-red-100 text-red-700';
                    resultMessage.textContent = `âŒ æ­¤é¡Œå·²ç­”éŒ¯ï¼Œæ©Ÿæœƒå·²ç”¨ç›¡ã€‚ä½ é¸æ“‡äº† (${stateObj.choice})ï¼Œæ­£ç¢ºç­”æ¡ˆæ˜¯ ${OPTIONS_LABELS[question.answerIndex]}ã€‚`;
                    correctBtn.classList.add('border-4', 'border-green-500', 'bg-green-50');
                }
                resultMessage.classList.remove('hidden');

            } 
            else {
                reRenderOptions(index, false, failedOptions); 
                if (attemptsLeft <= 0) {
                    resultMessage.classList.remove('hidden');
                    resultMessage.className = 'mt-6 p-3 rounded-lg text-center font-bold bg-red-100 text-red-700';
                    resultMessage.textContent = `âš ï¸ æ³¨æ„ï¼šæ‰€æœ‰ç­”éŒ¯æ©Ÿæœƒå·²ç”¨ç›¡ï¼Œè«‹è¬¹æ…ä½œç­”ï¼`;
                }
            }

            modal.classList.remove('hidden');
        }

        /**
         * éš±è—é¡Œç›®æ¨¡æ…‹æ¡†
         */
        function closeModal() {
            clearTimeout(autoCloseTimer);
            modal.classList.add('hidden');
            currentQuestionIndex = -1;
            checkBingo(); 
        }

        /**
         * åˆå§‹åŒ–è³“æœç¶²æ ¼
         */
        function initializeGrid() {
            bingoGrid.innerHTML = '';
            QUESTIONS.forEach((q, index) => {
                const cell = document.createElement('div');
                cell.id = `cell-${index}`;
                cell.className = 'bingo-cell flex items-center justify-center p-3 rounded-lg bg-gray-50 hover:bg-yellow-100 text-xl font-bold text-gray-700 select-none';
                cell.textContent = `Q${index + 1}`;
                cell.onclick = () => openModal(index);
                bingoGrid.appendChild(cell);
            });
            updateScore();
            checkBingo();
            updateAttemptsDisplay(); 
        }

        /**
         * è¨­ç½®æ’åä¸¦é–‹å§‹éŠæˆ²
         */
        function startGame(attempts) {
            TOTAL_MAX_ATTEMPTS = attempts; 

            rankScreen.classList.add('hidden');
            bingoApp.classList.remove('hidden');

            // é‡ç½® quizState çµæ§‹
            quizState = Array(9).fill().map(() => ({ state: 0, choice: '' }));
            totalFailedAttempts = 0; 

            initializeGrid();
        }

        // ----------------------------------------------------
        // 5. å•Ÿå‹•æ‡‰ç”¨ç¨‹å¼
        // ----------------------------------------------------
        window.onload = function() {
            rankScreen.classList.remove('hidden');
            bingoApp.classList.add('hidden');
            
            // å°‡ startGame/closeModal å‡½å¼æš´éœ²çµ¦æŒ‰éˆ•é»æ“Šäº‹ä»¶
            window.startGame = startGame;
            window.closeModal = closeModal;
        };
    </script>
</body>
</html>